{{> partials/backoffice/header }}

<main class="admin-main">
    <div class="admin-header">
        <h1>Gestão de Reviews</h1>
    </div>

    <div class="search-container admin-filters">
        <form action="/backoffice/reviews" method="GET" style="display:flex; width:100%; gap:20px;">
            <div class="search-input-wrapper">
                <input type="text" name="q" value="{{query}}" placeholder="pesquise no conteúdo da crítica">
                <button type="submit"><img src="/public/images/icon-search.svg" alt="Pesquisar"></button>
            </div>
        </form>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="th-id">ID</th>
                    <th>Utilizador</th>
                    <th>Filme/Série</th>
                    <th class="th-rating">Rating</th>
                    <th>Comentário</th>
                    <th class="th-actions">Ações</th>
                </tr>
            </thead>
            <tbody>
                {{#data}}
                <tr id="review-row-{{id}}">
                    <td>#{{id}}</td>
                    <td class="primary-text">{{utilizador_nome}}</td>
                    <td>{{conteudo_nome}}</td>
                    <td>
                        <span class="badge badge-diretor">{{classificacao}}/10</span>
                    </td>
                    <td class="comment-preview" title="{{critica}}">{{critica}}</td>
                    <td class="actions-cell">
                        <button class="btn-action btn-delete" onclick="deleteReview('{{id}}')" title="Apagar">&#128465;</button>
                    </td>
                </tr>
                {{/data}}
                {{^data}}
                <tr>
                    <td colspan="6" style="text-align:center; padding: 40px; color: #888;">Nenhuma review encontrada.</td>
                </tr>
                {{/data}}
            </tbody>
        </table>
    </div>
</main>

<script>
async function deleteReview(id) {
    if (!confirm('Deseja eliminar esta crítica permanentemente?')) return;

    try {
        // Faz a chamada ao teu Controller (ReviewController.delete)
        const response = await fetch(`/backoffice/reviews/${id}`, { 
            method: 'DELETE' 
        });
        
        const result = await response.json();

        // Verifica se o Controller respondeu com success: true
        if (response.ok && result.success) {
            const row = document.getElementById(`review-row-${id}`);
            if (row) {
                // Efeito visual simples antes de remover
                row.style.backgroundColor = "#ffe6e6";
                row.style.transition = "opacity 0.3s ease";
                row.style.opacity = "0";
                
                setTimeout(() => {
                    row.remove();
                    // Opcional: se a tabela ficar vazia após remover, recarregar para mostrar a mensagem "vazio"
                    if (document.querySelectorAll('tbody tr').length === 0) {
                        window.location.reload();
                    }
                }, 300);
            }
        } else {
            alert("Erro ao eliminar: " + (result.error || "Erro desconhecido"));
        }
    } catch (error) {
        console.error("Erro na requisição:", error);
        alert("Erro de ligação ao servidor.");
    }
}
</script>

{{> partials/backoffice/footer }}